---
title: "AWS SDK v2 for Java + Proxy(Bearer èªè¨¼) ãŒå‹•ã‹ãªã„ç†ç”±ã¨ Apache5 ã«ã‚ˆã‚‹è§£æ±ºç­–"
emoji: "ğŸ“‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["java", "aws", "proxy", "network", "http"]
published: true
published_at: 2025-12-25 00:00
---

## ã¯ã˜ã‚ã«
æœ¬è¨˜äº‹ã§ã¯ã€AWS SDK v2 for Java ã‚’ä½¿ã£ã¦ Bearer èªè¨¼ã¤ã Proxy ã‚’çµŒç”±ã—ã€AWS API ã‚’å‘¼ã³å‡ºã™æ–¹æ³•ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

çµè«–ã‹ã‚‰è¨€ã†ã¨ã€  
AWS SDK v2 ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ§‹æˆã§ã¯ Bearer èªè¨¼ã¤ã Proxy ã‚’ãã®ã¾ã¾é€šã™ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚

ãã®ç†ç”±ã¯ã€Œã©ã®ãƒ¬ã‚¤ãƒ¤ã§èªè¨¼ãŒè¡Œã‚ã‚Œã‚‹ã®ã‹ã€ã«ã‚ã‚Šã¾ã™ã€‚  
ã“ã®è¨˜äº‹ã§ã¯ã€å®Ÿéš›ã«è©¦ã—ãŸå¤±æ•—ä¾‹ã‚’æ•´ç†ã—ãªãŒã‚‰  

- ã©ã“ã« Bearer èªè¨¼ã‚’å…¥ã‚Œã‚Œã°ã‚ˆã„ã®ã‹  
- ãªãœ SDK ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ã¯è§£æ±ºã—ãªã„ã®ã‹  
- Apache5 ã‚’ä½¿ã†ã“ã¨ã§ãªãœè§£æ±ºã™ã‚‹ã®ã‹  

ã‚’è§£èª¬ã—ã¦ã„ãã¾ã™ã€‚

## AWS SDK v2 ã®Proxyè¨­å®šã‚’ç¢ºèª

AWS SDK v2 for Java ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€æ¬¡ã®ã‚ˆã†ã« Proxy è¨­å®šãŒç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ã€‚

> [HTTP ãƒ—ãƒ­ã‚­ã‚·ã®è¨­å®šï¼ˆã‚³ãƒ¼ãƒ‰ã§ã®è¨­å®šï¼‰](https://docs.aws.amazon.com/ja_jp/sdk-for-java/latest/developer-guide/http-config-proxy-support.html#http-config-proxy-support-in-code) ã‚ˆã‚Š
```java
SdkHttpClient httpClient1 = ApacheHttpClient.builder()
    .proxyConfiguration(ProxyConfiguration.builder()
        .endpoint(URI.create("http://proxy.example.com"))
        .username("username")
        .password("password")
        .addNonProxyHost("localhost")
        .build())
    .build();

S3Client s3Client = S3Client.builder()
    .httpClient(httpClient)
    .build();
```    

[å…¬å¼è³‡æ–™](https://docs.aws.amazon.com/ja_jp/sdk-for-java/latest/developer-guide/http-config-proxy-support.html#http-config-proxy-support-external)(2025/12/24 æ™‚ç‚¹)ã§ã¯ã€AWS SDK v2 ã¯ `ProxyConfiguration` ã‚’é€šã˜ã¦ Proxy ã® `endpoint`, `username`, `password` ã‚’æŒ‡å®šå¯èƒ½ã§ã™ãŒï¼Œå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯Basic èªè¨¼ä»¥å¤–ã® Proxy èªè¨¼æ–¹å¼ã¯æ˜è¨˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚

## è‡ªåŠ›ã§ãƒ˜ãƒƒãƒ€ãƒ¼ä»˜ä¸

Proxy ãŒ Bearer èªè¨¼ã‚’è¦æ±‚ã™ã‚‹å ´åˆã€ä¸‹è¨˜ã®ã‚ˆã†ãªãƒ˜ãƒƒãƒ€ãƒ¼ãŒå¿…è¦ã¨ãªã‚Šã¾ã™ã€‚

```bash
Proxy-Authorization: Bearer <token>
```

ãã“ã§ã€AWS SDK å†…ã®å‡¦ç†ã‚’ãƒ•ãƒƒã‚¯ã—ã¦ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ä¸ã™ã‚‹æ–¹æ³•ã‚’2ç¨®é¡è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚

### æ¡ˆ1: Interceptor ã‚’åˆ©ç”¨ã—ãƒ˜ãƒƒãƒ€ãƒ¼ä»˜ä¸  
ExecutionInterceptorã‚’ç”¨ã„ã¦ã€SDK ãŒé€ã‚‹ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ ã™ã‚‹æ–¹æ³•ã‚’è©¦ã—ã¾ã—ãŸã€‚
```java
public class RequestInterceptor implements ExecutionInterceptor {
  @Override
  public SdkHttpRequest modifyHttpRequest(
      Context.ModifyHttpRequest context, ExecutionAttributes executionAttributes) {

    return context.httpRequest().toBuilder()
        .putHeader("Proxy-Authorization", StandardAuthScheme.BEARER + " " + "test-token")
        .build();
  }
}
```

### æ¡ˆ2: SdkHttpClientã‚’ãƒ©ãƒƒãƒ—ã—ã¦ãƒ˜ãƒƒãƒ€ãƒ¼ä»˜ä¸
SdkHttpClient ã‚’ãƒ©ãƒƒãƒ—ã—ã€SDK ã§å®Ÿè¡Œã•ã‚Œã‚‹ã™ã¹ã¦ã® HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ ã™ã‚‹æ–¹æ³•ã‚’è©¦ã—ã¾ã—ãŸã€‚

```java
public class ProxyHeaderHttpClient implements SdkHttpClient {
  private final SdkHttpClient sdkHttpClient;

  public ProxyHeaderHttpClient(SdkHttpClient sdkHttpClient) {
    this.sdkHttpClient = sdkHttpClient;
  }

  @Override
  public ExecutableHttpRequest prepareRequest(HttpExecuteRequest request) {
    final var newRequestBuilder = request.httpRequest().toBuilder();
    newRequestBuilder.putHeader(
        "Proxy-Authorization", StandardAuthScheme.BEARER + " " + "test-token");

    final var newRequest =
        HttpExecuteRequest.builder()
            .request(newRequestBuilder.build())
            .contentStreamProvider(request.contentStreamProvider().orElse(null))
            .build();

    return sdkHttpClient.prepareRequest(newRequest);
  }

  @Override
  public void close() {
    sdkHttpClient.close();
  }
}
```

### çµæœï¼šã©ã¡ã‚‰ã‚‚ Bearer èªè¨¼ã¯å¤±æ•—

ç†ç”±ã¯ã€Proxy èªè¨¼ã¯ â€œã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆâ€ ã§ã¯ãªãã€â€œCONNECT ï¼ˆãƒˆãƒ©ãƒ³ã‚¹ãƒãƒ¼ãƒˆå±¤ï¼‰â€ ã§å‡¦ç†ã•ã‚Œã‚‹ãŸã‚ã§ã—ãŸã€‚

Interceptor / SdkHttpClient ãŒè§¦ã‚Œã‚‹ã®ã¯ â€œã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã® HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆâ€ã®ãŸã‚CONNECTã«å¯¾ã—ã¦ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚

å›³ã§è¡¨ã™ã¨æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```mermaid
sequenceDiagram
    participant App as Java App
    participant SDK as AWS SDK v2
    participant Intercept as Interceptor/SdkHttpClient
    participant Client as Apache HttpClient
    participant Proxy as Proxy Server

    App->>SDK: S3 API å‘¼ã³å‡ºã—
    SDK->>Intercept: HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆåŠ å·¥ (ãƒ˜ãƒƒãƒ€ä»˜ä¸)
    Intercept->>Client: åŠ å·¥æ¸ˆã¿ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ¸¡ã™

    Note right of Intercept: Interceptor / SdkHttpClient<br>ãŒè§¦ã‚Œã‚‹ã®ã¯ã“ã®ãƒ¬ã‚¤ãƒ¤ã ã‘

    Client->>Proxy: CONNECT (ãƒ˜ãƒƒãƒ€ãªã—)
    Proxy-->>Client: 407 Proxy Authentication Required

    Note right of Client: CONNECT ã¯ Apache HttpClient ã®è²¬å‹™<br>SDKãƒ¬ã‚¤ãƒ¤ã¯ä»‹å…¥ä¸å¯
```

ã¾ã¨ã‚ã‚‹ã¨ã€

- Interceptor ãŒè§¦ã‚Œã‚‹ã®ã¯ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ï¼ˆS3 API ã® HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰
- Proxy èªè¨¼ãŒè¡Œã‚ã‚Œã‚‹ã®ã¯ CONNECTï¼ˆãƒˆãƒ©ãƒ³ã‚¹ãƒãƒ¼ãƒˆå±¤ï¼‰
- CONNECT ã¯ Apache HttpClientï¼ˆTransport å±¤ï¼‰ã®å‡¦ç†
- AWS SDK ã¯ CONNECT ã‚’åŠ å·¥ã™ã‚‹ API ã‚’æä¾›ã—ã¦ã„ãªã„

ãã®ãŸã‚ã€ã©ã‚Œã ã‘ Interceptor ã‚„ SdkHttpClient ã‚’å·¥å¤«ã—ã¦ã‚‚
CONNECT ã« Bearer èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ã¯ã§ããªã„
ã¨ã„ã†æ§‹é€ çš„ãªé™ç•ŒãŒã‚ã‚Šã¾ã™ã€‚

## Proxy èªè¨¼ã®æœ¬è³ªï¼šCONNECT ã¨ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ¬ã‚¹ãƒãƒ³ã‚¹

ã“ã“ã¾ã§ã®å¤±æ•—ç†ç”±ã‚’è¸ã¾ãˆã€ãã‚‚ãã‚‚ Proxy èªè¨¼ï¼ˆç‰¹ã« HTTPS ã§ã®é€šä¿¡ï¼‰ãŒã©ã®ã‚ˆã†ã«è¡Œã‚ã‚Œã‚‹ã®ã‹ã‚’æ•´ç†ã—ã¾ã™ã€‚

HTTPS + Proxy ã®å ´åˆã€é€šä¿¡ã¯æ¬¡ã®ã‚ˆã†ã«é€²ã¿ã¾ã™ã€‚

1. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯æ¬¡ã®ã‚ˆã†ãª **CONNECT** ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ Proxy ã«é€ã£ã¦ãƒˆãƒ³ãƒãƒ«ã‚’ç¢ºç«‹ã™ã‚‹ã€‚
```bash
CONNECT s3.ap-northeast-1.amazonaws.com:443 HTTP/1.1
```

2. Proxy ãŒBearerèªè¨¼ã‚’è¦æ±‚ã—ã¦ã„ã‚‹å ´åˆã¯ã€æ¬¡ã®ã‚ˆã†ã« 407 ã‚’è¿”å´ã™ã‚‹ã€‚
```bash
HTTP/1.1 407 Proxy Authentication Required
Proxy-Authenticate: Bearer realm="proxy"
```

3. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ã“ã® â€œãƒãƒ£ãƒ¬ãƒ³ã‚¸â€ ã«å¿œã˜ã¦ã€**Bearer ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ä¸ã—ãŸ CONNECT ã‚’å†é€**ã™ã‚‹ã€‚

```bash
CONNECT ...
Proxy-Authorization: Bearer <token>
```

3. èªè¨¼ãŒæˆåŠŸã™ã‚‹ã¨ã€Proxy ã¯ãƒˆãƒ³ãƒãƒ«ã‚’é–‹æ”¾ã—ã€CONNECTå®Œäº†
```bash
HTTP/1.1 200 Connection established
````

4. TLS ãƒãƒ³ãƒ‰ã‚·ã‚§ã‚¤ã‚¯ãŒå§‹ã¾ã‚Šã€åˆã‚ã¦ S3 ã¸ã®é€šå¸¸ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€ã‚‰ã‚Œã¾ã™ã€‚


æ¬¡ã®ã‚ˆã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚

```mermaid
sequenceDiagram
    participant Client as Java Client
    participant Proxy as Proxy Server
    participant AWS as AWS Endpoint (S3)

    Client->>Proxy: CONNECT s3.amazonaws.com:443
    Proxy-->>Client: 407 Proxy Authentication Required<br/>Proxy-Authenticate: Bearer realm="proxy"

    Note right of Client: Bearer èªè¨¼ã‚’è¦æ±‚ã•ã‚ŒãŸãŸã‚<br>ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä»˜ä¸ã—ã¦å†é€ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

    Client->>Proxy: CONNECT + Proxy-Authorization: Bearer <token>
    Proxy-->>Client: 200 Connection established

    Note right of Proxy: ãƒˆãƒ³ãƒãƒ«ç¢ºç«‹å®Œäº†<br>ã“ã“ã‹ã‚‰ TLS ãƒãƒ³ãƒ‰ã‚·ã‚§ã‚¤ã‚¯

    Client->>AWS: GET /object (inside TLS)
    AWS-->>Client: 200 OK
````

ãƒã‚¤ãƒ³ãƒˆã¯æ¬¡ã®2ã¤ã§ã™ã€‚

1. Proxy èªè¨¼ã¯ CONNECTï¼ˆTCP ãƒˆãƒ³ãƒãƒ«ç¢ºç«‹ï¼‰ã®ãƒ•ã‚§ãƒ¼ã‚ºã§è¡Œã‚ã‚Œã‚‹  
2. CONNECT ã¯ Apache HttpClient ã®å†…éƒ¨å‡¦ç†ã§ã‚ã‚Šã€Interceptor ã‚„ SdkHttpClient ãŒè§¦ã‚Œã‚‹ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ã¯åˆ¥ç‰©

ã¤ã¾ã‚Šã€â€œã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã® HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã« Bearer ã‚’ä»˜ã‘ã¦ã‚‚æ„å‘³ãŒãªã„â€  ã¨ã„ã†æ§‹é€ ã«ãªã£ã¦ãŠã‚Šã€Bearer èªè¨¼ã‚’å®Ÿç¾ã™ã‚‹ã«ã¯ HttpClient å´ã«å®Ÿè£…ã—ãªã‘ã‚Œã°ã„ã‘ã¾ã›ã‚“ã€‚

## Apache4ï¼ˆHttpClient 4.xï¼‰ã§ã¯ Bearer èªè¨¼ã¯å¤±æ•—ã™ã‚‹

AWS SDK v2 ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ HTTP ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ Apache HTTP Client 4.xï¼ˆä»¥ä¸‹ Apache4ï¼‰ã§ã™ã€‚
ã—ã‹ã— Apache4 ã«ã¯Bearer èªè¨¼ã®å®Ÿè£…ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

https://github.com/apache/httpcomponents-client/blob/4.5.x/httpclient/src/main/java/org/apache/http/impl/client/AuthenticationStrategyImpl.java#L71-L78

ã“ã‚Œã‚ˆã‚ŠApache4ã§ã¯ä¸‹è¨˜ã®ã‚ˆã†ãªæŒ™å‹•ã¨ãªã‚Šã¾ã™ã€‚
HttpClient æœ¬ä½“ãŒ Bearer ã‚’èªè­˜ã§ããšæ°¸ä¹…ã« 407 ã®ã¾ã¾å¤±æ•—ã—ã¾ã™ã€‚

1. Proxy ã‹ã‚‰ 407 Proxy Authentication Required ã‚’å—ã‘å–ã‚‹
2. Bearer ã‚¹ã‚­ãƒ¼ãƒ ã‚’é¸æŠã§ããªã„
3. CONNECT ã‚’å†é€ã§ããªã„


## Apache5ï¼ˆHttpClient 5.xï¼‰ãªã‚‰ Bearer èªè¨¼ãŒå¯èƒ½
æ¬¡ã« Apache5ï¼ˆHttpClient5ï¼‰ã‚’è¦‹ã‚‹ã¨ã€Bearer èªè¨¼ãŒæ­£å¼ã«ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

https://github.com/apache/httpcomponents-client/blob/d07c8e26cbe69cc94e1b98ba8b5fdfb284244b6a/httpclient5/src/main/java/org/apache/hc/client5/http/impl/DefaultAuthenticationStrategy.java#L69-L74

ã“ã‚Œã‚ˆã‚ŠApache5ã§ã¯ä¸‹è¨˜ã®ã‚ˆã†ãªæŒ™å‹•ã¨ãªã‚Šã€Bearerèªè¨¼ã‚’æ­£ã—ãå‡¦ç†ã§ãã¾ã™ã€‚

1. Proxy ã‹ã‚‰ 407 Proxy Authentication Required ã‚’å—ã‘å–ã‚‹
2. Bearer ã‚¹ã‚­ãƒ¼ãƒ ã‚’é¸æŠ
3. Bearer ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç”Ÿæˆ
4. CONNECT ã‚’å†é€
5. èªè¨¼æˆåŠŸ â†’ ãƒˆãƒ³ãƒãƒ«ç¢ºç«‹

AWS SDK v2 ã§ã¯ã€Apache5 ãƒ™ãƒ¼ã‚¹ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒ preview ã¨ã—ã¦åˆ©ç”¨ã§ãã¾ã™ã€‚

[Preview Release of the AWS SDK Java 2.x HTTP Client built on Apache HttpClient 5.5.x](https://aws.amazon.com/jp/blogs/developer/preview-release-of-theaws-sdk-java-2-x-http-client-built-on-apache-httpclient-5-5-x/)

ã“ã‚Œã‚’ä½¿ã†ã“ã¨ã§ã€AWS SDK v2 ã§ Bearer èªè¨¼ä»˜ã Proxy ã‚’é€šã›ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

## Apache5ï¼ˆHttpClient5ï¼‰ã‚’ AWS SDK v2 ã§ä½¿ã†æ–¹æ³•

AWS SDK v2 ã¯ã€Apache5 ãƒ™ãƒ¼ã‚¹ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ preview ã¨ã—ã¦æä¾›ã—ã¦ã„ã¾ã™ã€‚

```gradle
implementation(platform("software.amazon.awssdk:bom:2.40.7"))
implementation("software.amazon.awssdk:s3")
implementation("software.amazon.awssdk:apache5-client")
```

ã—ã‹ã—ã€ã“ã‚Œã ã‘ã§ã¯ Bearer èªè¨¼ã¯å‹•ãã¾ã›ã‚“ã€‚

Apache5 ã¯ èªè¨¼ã‚¹ã‚­ãƒ¼ãƒ ãã®ã‚‚ã®ï¼ˆBEARERï¼‰ ã‚’æŒã£ã¦ã„ã¾ã™ãŒã€ã€Œã©ã® Bearer ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã†ã®ã‹ã€ã¯åˆ©ç”¨è€…ãŒæä¾›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãã®ãŸã‚ã«å¿…è¦ãªã®ãŒï¼š

- [AuthSchemeï¼ˆèªè¨¼ã‚¹ã‚­ãƒ¼ãƒ ã®å®Ÿä½“ï¼‰](https://github.com/apache/httpcomponents-client/blob/d07c8e26cbe69cc94e1b98ba8b5fdfb284244b6a/httpclient5/src/main/java/org/apache/hc/client5/http/auth/AuthScheme.java)

- [AuthSchemeFactoryï¼ˆã‚¹ã‚­ãƒ¼ãƒ ã‚’ç”Ÿæˆã™ã‚‹ Factoryï¼‰](https://github.com/apache/httpcomponents-client/blob/d07c8e26cbe69cc94e1b98ba8b5fdfb284244b6a/httpclient5/src/main/java/org/apache/hc/client5/http/auth/AuthSchemeFactory.java)

ã®2ã¤ã§ã™ã€‚

AuthScheme / AuthSchemeFactory ã®å½¹å‰²ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™

- **AuthScheme** : CONNECT ã®å†é€æ™‚ã«å®Ÿéš›ã®èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼```Proxy-Authorization: Bearer <token>```ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ã‚¯ãƒ©ã‚¹ã€‚

- **AuthSchemeFactory** : Apache5 ã«ã€ŒAuthScheme ã‚’ã©ã†ç”Ÿæˆã™ã‚‹ã‹ã€ã‚’ç™»éŒ²ã™ã‚‹ãŸã‚ã® Factoryã€‚

åˆ©ç”¨ã—ãŸã„èªè¨¼æ–¹å¼ã”ã¨ã«ä¸Šè¨˜ã®ã‚¯ãƒ©ã‚¹ã‚’å®Ÿè£…ã—ã€Apache5ã«ç™»éŒ²ã™ã‚‹ã¨æ¬¡ã®ã‚ˆã†ã«å‹•ãã¾ã™

1. Proxy ã‹ã‚‰ 407 Proxy Authentication Required ã‚’å—ä¿¡
2. èªè¨¼ã‚¹ã‚­ãƒ¼ãƒ ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã« BEARER ãŒã‚ã‚‹ã‹ç¢ºèª
3. ã‚ã‚Œã° AuthSchemeFactory ã‹ã‚‰ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ
4. ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã£ã¦ CONNECT ã‚’å†é€
5. èªè¨¼æˆåŠŸ â†’ 200 Connection established

### å®Ÿéš›ã® S3Clientè¨­å®šä¾‹
å‚è€ƒã¾ã§ã«å®Ÿè£…ã¯ä¸‹è¨˜ã®ã‚ˆã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚

#### BearerAuthScheme
ã“ã®ã‚¯ãƒ©ã‚¹ã¯ã€Proxy ã‹ã‚‰ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’å—ã‘ã¦ Bearer ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä»˜ä¸ã™ã‚‹ãŸã‚ã®èªè¨¼å‡¦ç†ã‚’æ‹…å½“ã—ã¾ã™ã€‚ 
```java
package com.example.aws_proxy_bearer_s3_demo_v3.auth;

import org.apache.hc.client5.http.auth.*;
import org.apache.hc.core5.http.HttpHost;
import org.apache.hc.core5.http.HttpRequest;
import org.apache.hc.core5.http.protocol.HttpContext;

import java.security.Principal;

public class BearerAuthScheme implements AuthScheme {

    private final String token;

    public BearerAuthScheme(String token) {
        this.token = token;
    }

    public String getName() {
        return StandardAuthScheme.BEARER;
    }
    ;

    public boolean isConnectionBased() {
        return false;
    }
    ;

    public void processChallenge(AuthChallenge authChallenge, HttpContext context)
            throws MalformedChallengeException {}
    ;

    public boolean isChallengeComplete() {
        return false;
    }
    ;

    public String getRealm() {
        return null;
    }
    ;

    public boolean isResponseReady(
            HttpHost host, CredentialsProvider credentialsProvider, HttpContext context)
            throws AuthenticationException {
        return true;
    }
    ;

    public Principal getPrincipal() {
        return null;
    }
    ;

    public String generateAuthResponse(HttpHost host, HttpRequest request, HttpContext context)
            throws AuthenticationException {
        return StandardAuthScheme.BEARER + " " + token;
    }
    ;
}
```
### BearerAuthSchemeFactory
Apache5 ã«ç™»éŒ²ã™ã‚‹ãŸã‚ã® Factory ã§ã™ã€‚
SDK ã¯ã€Œèªè¨¼ã‚¹ã‚­ãƒ¼ãƒ ã®ç”Ÿæˆã€ã‚’ Factory ã‹ã‚‰è¡Œã†ãŸã‚ã€ã“ã®ã‚¯ãƒ©ã‚¹ãŒå¿…é ˆã¨ãªã‚Šã¾ã™ã€‚

```java
package com.example.aws_proxy_bearer_s3_demo_v3.auth;

import org.apache.hc.client5.http.auth.AuthScheme;
import org.apache.hc.client5.http.auth.AuthSchemeFactory;
import org.apache.hc.core5.http.protocol.HttpContext;

public class BearerAuthSchemeFactory implements AuthSchemeFactory {
    private final String token;

    public BearerAuthSchemeFactory(String token) {
        this.token = token; 
    }

    @Override
    public AuthScheme create(HttpContext context) {
        // tokenãªã©ã€ç”Ÿæˆå‡¦ç†ã‚’æœ¬æ¥ã§ã‚ã‚Œã°å®Ÿè£…
        // ç¾åœ¨ã¯ãƒ€ãƒŸãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®šã—ã¦ã„ã‚‹ã®ã¿
        return new BearerAuthScheme(token); 
    }
}

```

#### Apache5HttpClient ã«ã‚¹ã‚­ãƒ¼ãƒ ã‚’ç™»éŒ²ã—ã¦ S3Client ã‚’çµ„ã¿ç«‹ã¦ã‚‹

```java
package com.example.aws_proxy_bearer_s3_demo_v3.config;

import com.example.aws_proxy_bearer_s3_demo_v3.auth.BearerAuthSchemeFactory;
import com.example.aws_proxy_bearer_s3_demo_v3.config.properties.AwsS3Properties;
import com.example.aws_proxy_bearer_s3_demo_v3.config.properties.ProxyProperties;
import org.apache.hc.client5.http.auth.AuthSchemeFactory;
import org.apache.hc.client5.http.auth.StandardAuthScheme;
import org.apache.hc.core5.http.config.RegistryBuilder;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import software.amazon.awssdk.auth.credentials.AnonymousCredentialsProvider;
import software.amazon.awssdk.core.client.config.ClientOverrideConfiguration;
import software.amazon.awssdk.core.retry.RetryMode;
import software.amazon.awssdk.http.apache5.Apache5HttpClient;
import software.amazon.awssdk.http.apache5.ProxyConfiguration;
import software.amazon.awssdk.services.s3.S3Client;

import javax.net.ssl.TrustManager;
import javax.net.ssl.X509TrustManager;
import java.net.URI;
import java.security.cert.X509Certificate;
import java.time.Duration;

@Configuration
@EnableConfigurationProperties({AwsS3Properties.class, ProxyProperties.class})
public class S3Config {

  @Bean
  public S3Client s3Client(AwsS3Properties s3Props, ProxyProperties proxyProps) {
    final var proxy =
            ProxyConfiguration.builder().endpoint(URI.create(proxyProps.url())).build();

     final var authSchemeRegistryLookup =
             RegistryBuilder.<AuthSchemeFactory>create()
                     .register(
                             StandardAuthScheme.BEARER,
                             new BearerAuthSchemeFactory(proxyProps.bearerToken()))
                     .build();

    final var apache5HttpClient =
            Apache5HttpClient.builder()
                    .proxyConfiguration(proxy)
                    .authSchemeRegistry(authSchemeRegistryLookup)
                    .connectionTimeout(Duration.ofSeconds(5))
                    .socketTimeout(Duration.ofSeconds(5))
                    .tlsTrustManagersProvider(() -> new TrustManager[] {
                            new X509TrustManager() {
                              @Override
                              public X509Certificate[] getAcceptedIssuers() {
                                return new X509Certificate[0];
                              }
                              @Override
                              public void checkClientTrusted(X509Certificate[] certs, String authType) {}
                              @Override
                              public void checkServerTrusted(X509Certificate[] certs, String authType) {}
                            }
                    })
                    .build();

    final var overrideConfig =
            ClientOverrideConfiguration.builder()
                    .apiCallAttemptTimeout(Duration.ofSeconds(30))
                    .apiCallAttemptTimeout(Duration.ofSeconds(30))
                    .retryStrategy(RetryMode.STANDARD)
                    .build();

    return S3Client.builder()
            .httpClient(apache5HttpClient)
            .credentialsProvider(AnonymousCredentialsProvider.create())
            .region(s3Props.region())
            .overrideConfiguration(overrideConfig)
            .build();
  }
}
```

### ã“ã®è¨­å®šãŒæ‹…ã†å½¹å‰²

* `ProxyConfiguration`
  â†’ Proxy ã® endpoint ã‚’è¨­å®šï¼ˆBearer ã¯ã“ã“ã§ã¯è¨­å®šã—ãªã„ï¼‰

* `authSchemeRegistry`
  â†’ Bearer èªè¨¼ã‚¹ã‚­ãƒ¼ãƒ ã‚’ Apache5 ã«ç™»éŒ²
  â†’ **407 å¿œç­”ã‚’å—ã‘ãŸæ™‚ã€Bearer ã‚’ä½¿ç”¨ã—ã¦ CONNECT ã‚’å†é€å¯èƒ½ã«ã™ã‚‹**

* `Apache5HttpClient`
  â†’ CONNECT ã‚’å«ã‚€ãƒˆãƒ©ãƒ³ã‚¹ãƒãƒ¼ãƒˆå±¤ã®å‡¦ç†ã‚’æ‹…ã†
  â†’ ã“ã“ã§åˆã‚ã¦ Bearer ãŒæ©Ÿèƒ½ã™ã‚‹

* `S3Client.builder().httpClient(apache5)`
  â†’ Apache5 ãŒ CONNECT ã‚’å‡¦ç†ã—ã€SDK ãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã‚’å‡¦ç†ã™ã‚‹æµã‚Œã‚’æ§‹ç¯‰


## ã¾ã¨ã‚

* Proxy Bearer èªè¨¼ã¯ **CONNECTï¼ˆãƒˆãƒ©ãƒ³ã‚¹ãƒãƒ¼ãƒˆå±¤ï¼‰** ã§è¡Œã‚ã‚Œã‚‹
* Interceptor/SdkHttpClient ã¯ **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤**ã—ã‹åŠ å·¥ã§ããªã„
* AWS SDK v2 ã¯ Bearer èªè¨¼ã‚’æ¨™æº–ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„
* Apache4 ã« Bearer èªè¨¼ã‚¹ã‚­ãƒ¼ãƒ ã¯å­˜åœ¨ã—ãªã„
* Apache5 ã§ã¯ Bearer èªè¨¼ãŒæ­£å¼ã‚µãƒãƒ¼ãƒˆï¼ˆãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ¬ã‚¹ãƒãƒ³ã‚¹å¯¾å¿œï¼‰
* Apache5 + AuthSchemeFactory ã‚’ä½¿ãˆã° Bearer Proxy èªè¨¼ãŒå¯èƒ½ã«ãªã‚‹

Apache5 ã‚’ä½¿ã†ã“ã¨ã§ã€Bearer èªè¨¼ä»˜ã Proxy çµŒç”±ã§ã® S3 ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

## å‚è€ƒæ–‡çŒ®ï¼ˆå…¬å¼ãƒ»ä¸€æ¬¡æƒ…å ±ï¼‰

* AWS SDK for Java â€” Proxy è¨­å®š
  [https://docs.aws.amazon.com/ja_jp/sdk-for-java/latest/developer-guide/http-config-proxy-support.html](https://docs.aws.amazon.com/ja_jp/sdk-for-java/latest/developer-guide/http-config-proxy-support.html)
* AWS SDK v2 â€” Apache5 HttpClientï¼ˆpreviewï¼‰
  [https://sdk.amazonaws.com/java/api/latest/software/amazon/awssdk/http/apache5/Apache5HttpClient.Builder.html](https://sdk.amazonaws.com/java/api/latest/software/amazon/awssdk/http/apache5/Apache5HttpClient.Builder.html)

* Apache HttpClient4 â€” èªè¨¼ã‚¹ã‚­ãƒ¼ãƒ 
  [https://github.com/apache/httpcomponents-client/blob/4.5.x/httpclient/src/main/java/org/apache/http/impl/client/AuthenticationStrategyImpl.java](https://github.com/apache/httpcomponents-client/blob/4.5.x/httpclient/src/main/java/org/apache/http/impl/client/AuthenticationStrategyImpl.java)
* Apache HttpClient5 â€” èªè¨¼ã‚¹ã‚­ãƒ¼ãƒ 
  [https://github.com/apache/httpcomponents-client/blob/d07c8e26cbe69cc94e1b98ba8b5fdfb284244b6a/httpclient5/src/main/java/org/apache/hc/client5/http/impl/DefaultAuthenticationStrategy.java](https://github.com/apache/httpcomponents-client/blob/d07c8e26cbe69cc94e1b98ba8b5fdfb284244b6a/httpclient5/src/main/java/org/apache/hc/client5/http/impl/DefaultAuthenticationStrategy.java)
* AuthScheme ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹
  [https://github.com/apache/httpcomponents-client/blob/master/httpclient5/src/main/java/org/apache/hc/client5/http/auth/AuthScheme.java](https://github.com/apache/httpcomponents-client/blob/master/httpclient5/src/main/java/org/apache/hc/client5/http/auth/AuthScheme.java)
* AuthSchemeFactory
  [https://github.com/apache/httpcomponents-client/blob/master/httpclient5/src/main/java/org/apache/hc/client5/http/auth/AuthSchemeFactory.java](https://github.com/apache/httpcomponents-client/blob/master/httpclient5/src/main/java/org/apache/hc/client5/http/auth/AuthSchemeFactory.java)
